#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

resolve_max_panes() {
  if [[ -n "${AW_MAX_PANES:-}" ]]; then
    echo "$AW_MAX_PANES"
    return
  fi

  local config_path="$SCRIPT_DIR/../config/team_grid.json"
  if [[ ! -f "$config_path" ]]; then
    echo "10"
    return
  fi

  python3 - "$config_path" <<'PY'
import json
import sys

path = sys.argv[1]
default = 10
try:
    with open(path, "r", encoding="utf-8") as handle:
        data = json.load(handle)
    profiles = data.get("profiles", {}) if isinstance(data, dict) else {}
    current = str(profiles.get("current") or "default")
    items = profiles.get("items", {}) if isinstance(profiles.get("items"), dict) else {}
    item = items.get(current, {}) if isinstance(items.get(current), dict) else {}
    value = item.get("max_panes")
    if isinstance(value, int) and value > 0:
        print(value)
        raise SystemExit(0)
except Exception:
    pass
print(default)
PY
}

if [[ $# -eq 0 || "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  cat <<'EOF'
Agent Wrangler shortcuts:
  start
    -> routed to: teams up --rebuild --mode import --preserve-duplicates --startup --agent --nav --manager --manager-replace
  up|bootstrap|import|attach|status|paint|watch|manager|nav|send|stop|restart|agent|focus|kill|shell|layout|capture|projects|persistence|profile|hooks|doctor|drift
    -> routed to: teams <command>
  fleet ...
    -> routed to: teams fleet ...
  program ...
    -> routed to: program_orchestrator.py
  overview
    -> routed to: ui

Examples:
  ./scripts/agent-wrangler start
  ./scripts/agent-wrangler up --rebuild --mode import --preserve-duplicates --max-panes 10 --nav --manager --manager-replace
  ./scripts/agent-wrangler fleet manager --replace --update-defaults
  ./scripts/agent-wrangler drift --fleet --alert-dirty 25
  ./scripts/agent-wrangler program phases --refresh-state
  ./scripts/agent-wrangler program promote
  ./scripts/agent-wrangler program loop --iterations 1 --apply-safe --write-report
  ./scripts/agent-wrangler program daemon --apply-guardrails
EOF
  echo ""
  exec python3 "$SCRIPT_DIR/command_center.py" --help
fi

case "${1:-}" in
  start)
    shift
    MAX_PANES="$(resolve_max_panes)"
    set -- teams up --rebuild --mode import --preserve-duplicates --max-panes "$MAX_PANES" --startup --agent --nav --manager --manager-replace "$@"
    ;;
  up|bootstrap|import|attach|status|paint|watch|manager|nav|send|stop|restart|agent|focus|kill|shell|layout|capture|projects|persistence|profile|hooks|doctor|drift)
    set -- teams "$@"
    ;;
  fleet)
    set -- teams "$@"
    ;;
  program)
    shift
    exec python3 "$SCRIPT_DIR/program_orchestrator.py" "$@"
    ;;
  overview)
    shift
    set -- ui "$@"
    ;;
esac

exec python3 "$SCRIPT_DIR/command_center.py" "$@"
